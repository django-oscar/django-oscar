========================================
Oscar 2.1 release notes (in development)
========================================

:release: tbd

Welcome to Oscar 2.1.

.. contents::
    :local:
    :depth: 1

.. _compatibility_of_2.1:

Compatibility
~~~~~~~~~~~~~


.. _new_in_2.1:

What's new in Oscar 2.1?
~~~~~~~~~~~~~~~~~~~~~~~~

- The database performance of ``offer.Range.all_products()`` was substantially
  improved. The internals of that method have changed and specifically
  ``Range.invalidate_cached_ids()`` has been removed and replaced with
  ``Range.invalidate_cached_queryset()``.

- The ``upload_to`` argument of image fields in Oscar's ``ProductImage`` and
  ``ProductAttributeValue`` models was changed to use a callable, so that
  Django doesn't generate migrations if a project modifies the ``OSCAR_IMAGE_FOLDER``
  to specify a custom directory structure for uploaded images.

- Added ``communication`` app.

- Models ``CommunicationEventType``, ``Email`` and ``Notification`` moved from
  ``customer`` app to ``communication`` app.

  This is a change that requires database migration.

- ``Dispatcher`` moved from ``customer.utils`` to ``communication.utils``.
  Now ``Dispatcher`` is responsible for sending notifications as well as emails.

- ``CustomerDispatcher`` util created in ``customer`` app - to send customer
  related emails.

- ``AlertsDispatcher`` util created in ``customer.alerts`` module - to send
  order product alerts related emails and notifications.

- ``OrderDispatcher`` util created in ``order`` app - to send order related
  emails.

- Added ability to chose if sent email should be saved to DB (through
  ``OSCAR_SAVE_SENT_EMAILS_TO_DB``, ``True`` by default).

- Event codes (for each separate email) now kept in related "Dispatcher".

- Added ability to send emails with attachments.

- All emails' templates (``commtype_*``) moved from ``customer/emails``
  to ``communication/emails``.

- Templates from ``customer/email/*.html`` and ``customer/notification/*.html``
  moved to ``communication/email/*.html`` and ``communication/notification/*.html``.

- Models ``CommunicationEventType``, ``Email`` and ``Notification`` added to
  ``MOVED_MODELS`` to show warning when they will be imported from ``customer`` app.
  E.g. ``Email = get_model('customer', 'Email')``.

- Added ``absolute_url`` template tag - to get absolute URLs in templates based on
  provided path and domain. The schema for absolute url can be set through
  ``OSCAR_URL_SCHEMA`` setting, ``http`` by default.

Backwards incompatible changes in Oscar 2.1
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

- Field ``category`` removed from ``Notification`` model.

  This is a change that requires database migration.

- ``send_confirmation_message`` method of ``checkout.mixins.OrderPlacementMixin``
  replaced with ``send_order_placed_email`` method.

- ``customer.notifications.context_processors.notifications`` replaced with
  ``communication.notifications.context_processors.notifications``.

Bug fixes
~~~~~~~~~

- Fixed a bug in the handling of requests to save an item in the basket for
  later(:issue:`3215`).

- Fixed an error when deleting an offer whose related conditions/benefits have
  been deleted.

Removal of deprecated features
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Minor changes
~~~~~~~~~~~~~

- ``OrderPlacementMixin.place_order`` now ignores inactive vouchers when placing
  an order (instead of raising an exception), for consistency with how
  the basket flows handle inactive vouchers.

- Fixed the logic of ``StockRequired.parent_availability_policy`` to use
  child products to determine availability of children, rather than the parent.


Dependency changes
~~~~~~~~~~~~~~~~~~

- Upgraded ``django-phonenumber-field`` to use the latest in the 3.x series.
- Upgraded ``select2`` to version 4.0.10.
- Upgraded ``inputmask`` to version 4.0.8.

.. _deprecated_features_in_2.1:

Deprecated features
~~~~~~~~~~~~~~~~~~~

- ``customer.alerts.utils.send_alerts`` is deprecated.
  Use ``send_alerts`` method of ``AlertsDispatcher`` instead.

- ``customer.alerts.utils.send_alert_confirmation`` is deprecated.
  Use ``send_product_alert_confirmation_email_for_user`` method of
  ``AlertsDispatcher`` instead.

- ``customer.alerts.utils.send_product_alerts`` is deprecated.
  Use ``send_product_alert_email_for_user`` method of ``AlertsDispatcher``
  instead.

- ``customer.notifications.services.notify_user`` is deprecated.
  Use ``notify_user`` method of ``Dispatcher``.

- ``customer.notifications.services.notify_users`` is deprecated.
  Use ``notify_users`` method of ``Dispatcher``.

- ``get_reset_url`` method of ``customer.forms.PasswordResetForm`` removed.
  ``save`` method modified to use added ``send_password_reset_email`` method.

- ``form_valid`` method of ``customer.views.ProfileUpdateView`` modified
  to use added ``send_email_changed_email`` method.

- ``form_valid`` method of ``customer.views.ChangePasswordView`` modified
  to use added ``send_password_changed_email`` method.
