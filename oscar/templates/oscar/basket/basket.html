{% extends "checkout/layout.html" %}
{% load currency_filters %}
{% load product_tags %}

{% block title %}
Basket | {{ block.super }}
{% endblock %}

{% block checkout-nav %}
<nav class="checkoutNav">
	<ul class="nav row-fluid">
		<li class="active span3">
			<h3>1. Basket</h3>
		</li>
		<li class="disabled span3">
			<h3>2. Shipping Address</h3>
		</li>
		<li class="disabled span3">
			<h3>3. Shipping Options</h3>
		</li>
		<!-- <li class="disabled span3">
			<h3>4. Payment</h3>
		</li> -->
		<li class="disabled span3">
			<h3>4. Place Order</h3>
		</li>
	</ul>
</nav>
{% endblock %}

{% block header %}
<div class="page-header">
    <h1>Basket</h1>
</div>
{% endblock header %}


{% block content %}

{% if basket_warnings %}
	<h5>Important messages about items in your basket</h5>
	{% for warning in basket_warnings %}
	<div class="alert">{{ warning }}</div>
	{% endfor %}
{% endif %}

{% if not basket.is_empty %}

<form action="." method="post" class="basket_summary" id="basket_formset">
    {% csrf_token %}
    {{ formset.management_form }}
    <table class="table table-striped table-bordered">
        <tbody>
        {% for form in formset %}
        <tr>
			<td>
				{{ form.id }}
				{% product_image form.instance.product as product_image %}
				<div style="width:100px">
					<a href="{{ product.get_absolute_url }}"><img class="thumbnail" src="{{ product_image.thumbnail_url }}" alt="{{ product.get_title }}"></a>
				</div>
				<a href="{{ form.instance.product.get_absolute_url }}">{{ form.instance.description }}</a><br/>
				{{ form.instance.product.stockrecord.availability }}
			</td>
			<td>
				{{ form.quantity }} <button class="btn btn-small">Update</button><br/>
				<a href="#" data-id="{{ forloop.counter0 }}" class="remove">Remove</a>
				{% if request.user.is_authenticated %}
					| <a href="#" data-id="{{ forloop.counter0 }}" class="save">Save for later</a>
				{% endif %}
				<div style="display:none">
					{{ form.save_for_later }}
					{{ form.DELETE }}
				</div>
			</td>
            <td>{{ form.instance.unit_price_incl_tax|currency }}</td>
            <td>{{ form.instance.line_price_incl_tax|currency }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</form>

<p id="voucher_form_link"><a href="#voucher">I have a voucher code...</a></p>
<div id="voucher_form_container" style="display:none">
	<h4>Voucher code</h4>
	<form action="{% url basket:vouchers-add %}" method="post" class="form-horizontal">
		{% csrf_token %}
		{% include "partials/form_fields.html" with form=voucher_form %}
		<div class="form-actions">
			<button class="btn btn-info">Add voucher</button>
			or <a href="#" id="voucher_form_cancel">cancel</a>
		</div>
	</form>
</div>

<div id="basket_totals">
	<table>
		{% with offer_discounts=basket.offer_discounts voucher_discounts=basket.grouped_voucher_discounts %}
		{% if offer_discounts or voucher_discounts %}
			<tr>
				<th>Basket total (before discounts)</th>
				<td>{{ basket.total_incl_tax_excl_discounts|currency }}</td>
			</tr>
			{% if offer_discounts %}
				<tr>
					<th>Site offers</th>
					<td></td>
				</tr>
				{% for discount in offer_discounts %}
				<tr>
					<td>{{ discount.name }}</td>
					<td>-{{ discount.discount|currency }}</td>
				</tr>
				{% endfor %}
			{% endif %}
			{% if voucher_discounts %}
				<tr>
					<th>Vouchers</th>
					<td></td>
				</tr>
				{% for discount in voucher_discounts %}
				<tr>
					<td>
						{{ discount.voucher.name }} ({{ discount.voucher.code }})
						<form action="{% url basket:vouchers-remove discount.voucher.id %}" method="POST">
							{% csrf_token %}
							<input type="submit" value="Remove" class="btn btn-small btn-danger"/>
						</form>
					</td>
					<td>-{{ discount.discount|currency }}</td>
				</tr>
				{% endfor %}
			{% endif %}
			<tr>
				<th>Basket total (after discounts)</th>
				<td>{{ basket.total_incl_tax|currency }}</td>
			</tr>
		{% else %}
			<tr>
				<th>Basket total</th>
				<td>{{ basket.total_incl_tax|currency }}</td>
			</tr>
		{% endif %}
		{% endwith %}
		<tr>
			<th>Shipping ({{ shipping_method.name }})</th>
			<td>{{ shipping_charge_incl_tax|currency }}</td>
		</tr>
		<tr>
			<th>Order total</th>
			<td>{{ order_total_incl_tax|currency }}</td>
		</tr>
	</table>
</div>
	
<div class="form-actions">
	<a href="{% url checkout:index %}" class="pull-right btn btn-large btn-primary">Proceed to checkout</a>
</div>

{% else %}

<p>Your basket is empty, you should probably add some items to buy.</p>

{% endif %}


<div class="page-header">
    <h2>To buy later</h2>
</div>

{% if not saved_formset %}
<p>Your saved basket is empty.</p>

{% else %}
<form action="{% url basket:saved %}" method="post" class="form-stacked later_summary" id="saved_basket_formset">
    {% csrf_token %}

    {{ saved_formset.management_form }}

    <table class="bordered-table zebra-striped">
        <tbody>
        {% for form in saved_formset %}
        <tr>
			<td>
				{{ form.id }}
				{% product_image form.instance.product as product_image %}
				<div style="width:100px">
					<a href="{{ product.get_absolute_url }}"><img class="thumbnail" src="{{ product_image.thumbnail_url }}" alt="{{ product.get_title }}"></a>
				</div>
				<a href="{{ form.instance.product.get_absolute_url }}">{{ form.instance.description }}</a><br/>
				{{ form.instance.product.stockrecord.availability }}
			</td>
			<td>
				<a href="#" data-id="{{ forloop.counter0 }}" class="remove">Remove</a>
				| <a href="#" data-id="{{ forloop.counter0 }}" class="move">Move to basket</a>
				<div style="display:none">
					{{ form.move_to_basket }}
					{{ form.DELETE }}
				</div>
			</td>
            <td>{{ form.instance.unit_price_incl_tax|currency }}</td>
            <td>{{ form.instance.line_price_incl_tax|currency }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="form-actions">
		<a href="{% url checkout:index %}" class="pull-right btn btn-primary btn-large">Proceed to Checkout</a>
    </div>

</form>
{% endif %}

{% endblock content %}

{% block onbodyload %}
oscar.basket.init();
{% endblock %}

